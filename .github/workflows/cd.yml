name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI - Build & Push Docker"]
    types: [ "completed" ]

permissions:
  contents: read

env:
  # SHA do commit do CI que disparou este CD
  CI_SHA: ${{ github.event.workflow_run.head_sha }}

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set vars
        id: vars
        shell: bash
        run: |
          IMAGE="${{ secrets.DOCKERHUB_IMAGE || 'adrianbranche/monitor' }}"
          TAG_SHA="${CI_SHA::7}"
          NS="${{ secrets.K8S_NAMESPACE || 'default' }}"
          echo "IMAGE=$IMAGE"     >> "$GITHUB_OUTPUT"
          echo "TAG_SHA=$TAG_SHA" >> "$GITHUB_OUTPUT"
          echo "NAMESPACE=$NS"    >> "$GITHUB_OUTPUT"
          echo "Usando imagem: $IMAGE:$TAG_SHA"

      - name: Validate kubeconfig & decide deploy
        id: kcfg
        shell: bash
        run: |
          REASON=""
          if [ -z "${{ secrets.KUBE_CONFIG_DATA }}" ]; then
            echo "DO_DEPLOY=false" >> "$GITHUB_OUTPUT"
            echo "REASON=KUBE_CONFIG_DATA não definido." >> "$GITHUB_OUTPUT"
          else
            echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > kcfg || true
            if [ ! -s kcfg ]; then
              echo "DO_DEPLOY=false" >> "$GITHUB_OUTPUT"
              echo "REASON=KUBE_CONFIG_DATA inválido (base64?)." >> "$GITHUB_OUTPUT"
            else
              if grep -qiE 'C:\\\\|\\.minikube\\\\|(^|[[:space:]])client-certificate:|(^|[[:space:]])client-key:|(^|[[:space:]])certificate-authority:' kcfg; then
                echo "DO_DEPLOY=false" >> "$GITHUB_OUTPUT"
                echo "REASON=kubeconfig aponta para paths locais (Windows/Minikube) ou usa certs por arquivo." >> "$GITHUB_OUTPUT"
              else
                echo "DO_DEPLOY=true" >> "$GITHUB_OUTPUT"
                mkdir -p "$HOME/.kube"
                mv kcfg "$HOME/.kube/config"
                chmod 600 "$HOME/.kube/config"
              fi
            fi
          fi

      - name: Skip deploy (no/invalid kubeconfig)
        if: steps.kcfg.outputs.DO_DEPLOY != 'true'
        shell: bash
        run: |
          echo "Pulando deploy via kubectl."
          echo "Motivo: ${{
            steps.kcfg.outputs.REASON || 'Sem motivo detalhado'
          }}"
          echo "Imagem publicada: ${{ steps.vars.outputs.IMAGE }}:${{ steps.vars.outputs.TAG_SHA }}"
          # Job termina com sucesso para não quebrar seu pipeline

      # Daqui para baixo só roda se DO_DEPLOY == true
      - name: Setup kubectl
        if: steps.kcfg.outputs.DO_DEPLOY == 'true'
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      # PowerShell, como você pediu
      - name: Create namespace if not exists (pwsh)
        if: steps.kcfg.outputs.DO_DEPLOY == 'true'
        shell: pwsh
        env:
          K8S_NAMESPACE: ${{ steps.vars.outputs_
